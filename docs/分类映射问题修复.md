# 分类映射问题修复

## 问题描述

在进行分类筛选时，后端API需要接收英文分类ID（如 `novel`、`textbook`），但前端传递的是中文分类名（如 `文学小说`、`教材教辅`），导致查询失败。

## 解决方案

在 `Books.vue` 中添加中文到英文的分类映射表。

## 修改内容

### 1. 添加分类映射表

在 `Books.vue` 的 `<script setup>` 部分添加：

```javascript
const categoryMap = {
  '教材教辅': 'textbook',
  '文学小说': 'novel',
  '计算机': 'computer',
  '经管': 'business',
  '外语': 'language',
  '其他': 'other'
}
```

### 2. 修改 fetchBooks 函数

在发送请求前，将中文分类名转换为英文ID：

```javascript
const fetchBooks = async () => {
  try {
    loading.value = true
    const params = {
      page: currentPage.value,
      pageSize: pageSize.value
    }
    
    if (searchQuery.value) {
      params.keyword = searchQuery.value
    }
    if (selectedCategory.value) {
      params.category = categoryMap[selectedCategory.value] || selectedCategory.value
    }
    if (selectedCondition.value) {
      params.condition = selectedCondition.value
    }
    if (sortBy.value !== 'default') {
      params.sortBy = sortBy.value
    }
    
    const res = await getBooks(params)
    if (res.code === 200) {
      books.value = res.data.list
      total.value = res.data.total
    }
  } catch (error) {
    console.error('获取书籍列表失败:', error)
  } finally {
    loading.value = false
  }
}
```

### 3. 修改 fetchCategories 函数

在获取分类列表时，将英文ID转换为中文显示：

```javascript
const fetchCategories = async () => {
  try {
    const res = await getCategories()
    if (res.code === 200) {
      const reverseMap = {}
      Object.entries(categoryMap).forEach(([cn, en]) => {
        reverseMap[en] = cn
      })
      categories.value = res.data.map(cat => reverseMap[cat.id] || cat.name)
    }
  } catch (error) {
    console.error('获取分类失败:', error)
  }
}
```

## 映射关系

| 中文分类名 | 英文分类ID | 后端字段 |
|----------|-----------|----------|
| 教材教辅 | textbook | categoryId |
| 文学小说 | novel | categoryId |
| 计算机 | computer | categoryId |
| 经管 | business | categoryId |
| 外语 | language | categoryId |
| 其他 | other | categoryId |

## 工作原理

### 1. 用户选择分类

用户在下拉框中选择中文分类名（如"文学小说"），存储在 `selectedCategory.value` 中。

### 2. 发送请求

在 `fetchBooks()` 函数中，通过 `categoryMap[selectedCategory.value]` 将中文转换为英文ID，然后发送给后端。

### 3. 显示分类

在 `fetchCategories()` 函数中，通过 `reverseMap[cat.id]` 将后端返回的英文ID转换回中文，用于下拉框显示。

## 测试验证

### 测试步骤

1. 打开书籍列表页 http://localhost:5174/books
2. 在分类下拉框中选择"文学小说"
3. 查看浏览器开发者工具的Network标签
4. 确认请求参数为 `category=novel`
5. 确认返回的书籍都是"文学小说"分类

### 预期结果

- ✅ 下拉框显示中文分类名
- ✅ 请求参数使用英文分类ID
- ✅ 返回的书籍分类正确

## 相关文件

- `src/views/Books.vue` - 书籍列表页

## 注意事项

1. **fallback处理**: 使用 `|| selectedCategory.value` 作为fallback，防止映射表中没有对应项
2. **双向映射**: 同时维护中文→英文和英文→中文的映射，确保显示和查询都正确
3. **数据一致性**: 确保映射表与后端数据库中的分类ID一致

## 扩展建议

如果后端后续添加新的分类，需要同时更新：

1. `categoryMap` - 中文到英文的映射
2. 后端数据库 - 添加新的分类记录（id和name字段）

## 示例

### 查询流程

```
用户选择: "文学小说"
  ↓
selectedCategory.value = "文学小说"
  ↓
categoryMap["文学小说"] = "novel"
  ↓
params.category = "novel"
  ↓
后端查询: SELECT * FROM book WHERE categoryId = 'novel'
  ↓
返回结果: categoryId = 'novel' 的书籍
```

### 显示流程

```
后端返回: { id: 'novel', name: '文学小说', icon: '📖' }
  ↓
reverseMap['novel'] = '文学小说'
  ↓
categories.value = ['文学小说', ...]
  ↓
下拉框显示: <option>文学小说</option>
```

## 修改状态

✅ 已完成 - 分类映射功能已实现并测试通过
