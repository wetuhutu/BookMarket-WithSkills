# 发布时间显示问题修复

## 问题描述

在书籍详情页面（BookDetail.vue）中，"发布时间"字段显示为空。

## 问题原因

### 1. 后端SQL查询缺少字段

`BookMapper.xml` 中的 `getBookById` 查询没有包含 `created_at` 字段：

```xml
<select id="getBookById" resultType="com.bookmarket.vo.BookVO">
    select
        b.id,
        b.title,
        b.author,
        b.isbn,
        b.publisher,
        b.publish_date ,
        b.pages,
        b.category_id ,
        b.`condition`,
        b.price,
        b.original_price ,
        b.stock,
        b.cover,
        b.images,
        b.description,
        u.id sellerId,
        u.username sellerName,
        u.seller_level ,
        u.seller_rating ,
        u.seller_is_verified  isVerified
    from book b
    join user u on b.seller_id = u.id
    where b.id = #{id}
</select>
```

### 2. BookVO类缺少字段

`BookVO.java` 类中没有 `createdAt` 字段和对应的getter/setter方法。

### 3. 前端期望的字段

前端模板期望使用 `book.createdAt` 来显示发布时间：

```vue
<div class="card p-4">
  <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">发布时间</div>
  <div class="font-semibold text-gray-900 dark:text-white">{{ formatRelativeTime(book.createdAt) }}</div>
</div>
```

## 解决方案

### 1. 修改 BookMapper.xml

在 `getBookById` 查询中添加 `b.created_at` 字段：

```xml
<select id="getBookById" resultType="com.bookmarket.vo.BookVO">
    select
        b.id,
        b.title,
        b.author,
        b.isbn,
        b.publisher,
        b.publish_date ,
        b.pages,
        b.category_id ,
        b.`condition`,
        b.price,
        b.original_price ,
        b.stock,
        b.cover,
        b.images,
        b.description,
        b.created_at ,
        u.id sellerId,
        u.username sellerName,
        u.seller_level ,
        u.seller_rating ,
        u.seller_is_verified  isVerified
    from book b
    join user u on b.seller_id = u.id
    where b.id = #{id}
</select>
```

### 2. 修改 BookVO.java

添加 `createdAt` 字段和对应的getter/setter方法：

```java
private String createdAt; // 创建时间

public String getCreatedAt() {
    return createdAt;
}

public void setCreatedAt(String createdAt) {
    this.createdAt = createdAt;
}
```

## 字段说明

### 发布时间 vs 出版时间

| 字段 | 数据库字段 | 含义 | 示例值 |
|------|-----------|------|--------|
| 发布时间 | created_at | 书籍上架到平台的时间 | 2026-01-25T15:39:24 |
| 出版时间 | publish_date | 书籍首次出版的时间 | 2015-06 |

### 前端显示逻辑

```javascript
export function formatRelativeTime(dateStr) {
  if (!dateStr) return ''
  
  const date = new Date(dateStr)
  const now = new Date()
  const diff = now - date
  
  const minute = 60 * 1000
  const hour = 60 * minute
  const day = 24 * hour
  
  if (diff < minute) return '刚刚'
  if (diff < hour) return `${Math.floor(diff / minute)}分钟前`
  if (diff < day) return `${Math.floor(diff / hour)}小时前`
  if (diff < 7 * day) return `${Math.floor(diff / day)}天前`
  return date.toLocaleDateString()
}
```

### 显示规则

- 1分钟内：刚刚
- 1小时内：X分钟前
- 1天内：X小时前
- 7天内：X天前
- 超过7天：显示日期（如：2026/1/25）

## 测试验证

### API返回数据

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "title": "百年孤独",
    "author": "加西亚·马尔克斯",
    "isbn": "9787544274242",
    "publisher": "南海出版公司",
    "publishDate": "2015-06",
    "pages": 360,
    "categoryId": "novel",
    "condition": "九成新",
    "price": 45.0,
    "originalPrice": 59.5,
    "stock": 20,
    "cover": "https://picsum.photos/400/600?random=1",
    "images": "[\"https://picsum.photos/800/600?random=11\", \"https://picsum.photos/800/600?random=12\"]",
    "description": "《百年孤独》是哥伦比亚 作家加西亚·马尔克斯的代表作...",
    "createdAt": "2026-01-25T15:39:24",
    "sellerId": 2,
    "sellerName": "seller_001",
    "sellerLevel": "金牌卖家",
    "sellerRating": 0.0,
    "salesCount": null,
    "verified": true
  }
}
```

### 前端显示

- **发布时间**：2026/1/25（因为距离当前时间超过7天）
- **出版时间**：2015-06

## 修改状态

✅ 已完成 - 发布时间显示问题已修复

## 相关文件

- `backend-code/src/main/resources/com/bookmarket/mapper/BookMapper.xml` - 添加 created_at 字段到查询
- `backend-code/src/main/java/com/bookmarket/vo/BookVO.java` - 添加 createdAt 字段和getter/setter
- `src/views/BookDetail.vue` - 前端显示逻辑（无需修改）

## 注意事项

1. **需要重启后端服务**：修改后端代码后需要重启Spring Boot应用才能生效
2. **日期格式**：后端返回的日期格式为 ISO 8601（`2026-01-25T15:39:24`），JavaScript的 `new Date()` 可以正确解析
3. **时区处理**：当前实现使用浏览器本地时区，如需统一时区，建议后端返回UTC时间并在前端转换
